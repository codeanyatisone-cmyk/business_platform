name: Deploy Business Platform Frontend

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: Deploy Frontend to Server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          set -e  # Exit on any error
          
          echo "ğŸš€ Starting frontend deployment process..."
          
          # Navigate to project directory
          cd /opt/business-project
          echo "ğŸ“ Current directory: $(pwd)"
          
          # Check if git repository exists and is clean
          if [ ! -d ".git" ]; then
            echo "âŒ Git repository not found. Cloning..."
            rm -rf * .*
            git clone https://github.com/codeanyatisone-cmyk/business_platform.git .
          fi
          
          # Pull latest changes
          echo "ğŸ“¥ Pulling latest changes from Git..."
          git fetch origin
          git reset --hard origin/main
          git clean -fd
          
          # Verify we have the business-platform directory
          if [ ! -d "business-platform" ]; then
            echo "âŒ business-platform directory not found!"
            ls -la
            exit 1
          fi
          
          # Navigate to frontend directory
          cd business-platform
          echo "ğŸ“ Building frontend in: $(pwd)"
          
          # Install dependencies
          echo "ğŸ“¦ Installing npm dependencies..."
          npm install
          
          # Build the application
          echo "ğŸ”¨ Building React application..."
          npm run build
          
          # Verify build was successful
          if [ ! -d "build" ]; then
            echo "âŒ Build failed - build directory not found!"
            exit 1
          fi
          
          echo "âœ… Build completed successfully"
          
          # Update static files in web directory
          echo "ğŸ“‚ Updating static files..."
          sudo mkdir -p /var/www/business-platform
          sudo cp -r build/* /var/www/business-platform/
          sudo chown -R www-data:www-data /var/www/business-platform
          
          # Update the serve process directory
          echo "ğŸ”„ Updating serve process..."
          mkdir -p /root/apps/business-platform/build
          cp -r build/* /root/apps/business-platform/build/
          
          # Restart serve process
          echo "ğŸ”„ Restarting serve process..."
          pkill -f 'serve -s build -l 3000' || true
          sleep 2
          
          # Start serve process
          cd /root/apps/business-platform
          nohup serve -s build -l 3000 > /tmp/business-platform.log 2>&1 &
          sleep 3
          
          # Verify serve process is running
          if ! pgrep -f 'serve -s build -l 3000' > /dev/null; then
            echo "âŒ Serve process failed to start!"
            cat /tmp/business-platform.log
            exit 1
          fi
          
          echo "âœ… Serve process started successfully"
          
          # Test the deployment
          echo "ğŸ§ª Testing deployment..."
          sleep 5
          
          # Test local connection
          if curl -f -s http://localhost:3000 > /dev/null; then
            echo "âœ… Local server responding"
          else
            echo "âŒ Local server not responding"
            exit 1
          fi
          
          # Test domain
          if curl -f -s http://v4.business > /dev/null; then
            echo "âœ… Domain responding"
          else
            echo "âš ï¸  Domain not responding (may be DNS/cache issue)"
          fi
          
          # Show deployment info
          echo "ğŸ“Š Deployment Summary:"
          echo "  - Git commit: $(cd /opt/business-project && git rev-parse HEAD)"
          echo "  - Build time: $(date)"
          echo "  - Serve process: $(pgrep -f 'serve -s build -l 3000')"
          echo "  - Domain: http://v4.business"
          
          echo "ğŸ‰ Frontend deployment completed successfully!"